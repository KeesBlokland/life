{% extends "base.html" %}
<!--
/home/life/app/templates/temp_calendar.html
Version: 1.0.5
Purpose: Interactive calendar view with event edit/delete/move functionality
Created: 2025-06-11
Updated: 2025-06-12 - Fixed template error for empty calendar cells, removed emojis
-->

{% block title %}Calendar - Life{% endblock %}

{% block template_info %}temp_calendar.html v1.0.3 - Interactive calendar{% endblock %}

{% block content %}
<div class="container">
    <h1>Calendar - {{ month }}/{{ year }}</h1>
    
    <div class="calendar-nav">
        <a href="{{ url_for('main.calendar', year=year, month=month-1 if month > 1 else 12) }}" class="button button-secondary">Previous</a>
        <a href="{{ url_for('main.calendar') }}" class="button">Today</a>
        <a href="{{ url_for('main.calendar', year=year, month=month+1 if month < 12 else 1) }}" class="button button-secondary">Next</a>
    </div>
    
    <div class="calendar-grid">
        <div class="calendar-header">
            <div>Mon</div>
            <div>Tue</div>
            <div>Wed</div>
            <div>Thu</div>
            <div>Fri</div>
            <div>Sat</div>
            <div>Sun</div>
        </div>
        
        {% for week in calendar_data %}
            {% for day in week %}
                <div class="calendar-day {% if day.is_today %}today{% endif %}" 
                     data-date="{{ day.date }}" 
                     ondrop="drop(event)" 
                     ondragover="allowDrop(event)"
                     onclick="window.location.href='{{ url_for('main.day_view', date_str=day.date.strftime('%Y-%m-%d')) if day.date else '#' }}'">>
                    {% if day.day %}
                        <div class="day-number">{{ day.day }}</div>
                        {% if day.events %}
                            {% for event in day.events %}
                            <div class="event" 
                                 draggable="true" 
                                 ondragstart="drag(event)" 
                                 data-event-id="{{ event.id }}"
                                 onclick="event.stopPropagation(); showEventMenu({{ event.id }}, '{{ event.title }}', event)">
                                <span class="event-title">{{ event.title }}</span>
                                {% if event.time %}
                                <span class="event-time">{{ event.time }}</span>
                                {% endif %}
                            </div>
                            {% endfor %}
                        {% endif %}
                    {% endif %}
                </div>
            {% endfor %}
        {% endfor %}
    </div>
    
    <div class="calendar-actions">
        <a href="{{ url_for('main.add_event') }}" class="button">Add Event</a>
    </div>
</div>

<!-- Event context menu -->
<div id="eventMenu" class="event-menu" style="display: none;">
    <button onclick="editEvent()" class="menu-item">‚úèÔ∏è Edit</button>
    <button onclick="deleteEvent()" class="menu-item menu-danger">üóëÔ∏è Delete</button>
    <button onclick="closeMenu()" class="menu-item">‚ùå Cancel</button>
</div>



<script>
let currentEventId = null;
let draggedEventId = null;

// Drag and drop functionality
function allowDrop(ev) {
    ev.preventDefault();
    ev.currentTarget.classList.add('drag-over');
}

function drag(ev) {
    draggedEventId = ev.target.getAttribute('data-event-id');
    ev.target.classList.add('dragging');
    ev.dataTransfer.setData("text", draggedEventId);
}

function drop(ev) {
    ev.preventDefault();
    ev.currentTarget.classList.remove('drag-over');
    
    const eventId = ev.dataTransfer.getData("text");
    const newDate = ev.currentTarget.getAttribute('data-date');
    
    if (eventId && newDate) {
        moveEventToDate(eventId, newDate);
    }
    
    // Clean up dragging class
    document.querySelectorAll('.event.dragging').forEach(el => {
        el.classList.remove('dragging');
    });
}

// Remove drag-over class when leaving
document.addEventListener('dragleave', function(ev) {
    if (ev.target.classList.contains('calendar-day')) {
        ev.target.classList.remove('drag-over');
    }
});

// Event context menu
function showEventMenu(eventId, eventTitle, event) {
    event.stopPropagation();
    currentEventId = eventId;
    
    const menu = document.getElementById('eventMenu');
    menu.style.display = 'block';
    menu.style.left = event.pageX + 'px';
    menu.style.top = event.pageY + 'px';
}

function editEvent() {
    if (currentEventId) {
        window.location.href = `/event/edit/${currentEventId}`;
    }
    closeMenu();
}

function deleteEvent() {
    if (currentEventId) {
        if (confirm('Are you sure you want to delete this event?')) {
            fetch(`/event/delete/${currentEventId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => {
                if (response.ok) {
                    location.reload();
                } else {
                    alert('Failed to delete event');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to delete event');
            });
        }
    }
    closeMenu();
}

function closeMenu() {
    document.getElementById('eventMenu').style.display = 'none';
    currentEventId = null;
}

// Close menu when clicking elsewhere
document.addEventListener('click', function(event) {
    if (!event.target.closest('.event-menu') && !event.target.closest('.event')) {
        closeMenu();
    }
});

// Move event to new date
function moveEventToDate(eventId, newDate) {
    fetch(`/event/move/${eventId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ new_date: newDate })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showFeedback(data.message);
            // Reload calendar after short delay
            setTimeout(() => location.reload(), 1000);
        } else {
            alert('Failed to move event: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to move event');
    });
}

function showFeedback(message) {
    const feedback = document.createElement('div');
    feedback.className = 'move-feedback';
    feedback.textContent = message;
    document.body.appendChild(feedback);
    
    setTimeout(() => {
        feedback.remove();
    }, 3000);
}
</script>
{% endblock %}